{% extends "base.html" %}

{% block title %}Dashboard - ICS to Google Calendar Sync{% endblock %}

{% block content %}
<div class="card">
    <h2>Dashboard</h2>
    
    {% if not config.ics_url %}
    <div class="status warning">
        ‚ö†Ô∏è No ICS URL configured. Please <a href="{{ url_for('config') }}">configure the sync settings</a> to get started.
    </div>
    {% else %}
    <div class="status success">
        ‚úì Sync is configured and running
    </div>
    {% endif %}
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
        <div style="min-width: 0;">
            <h3 style="font-size: 16px; margin-bottom: 10px;">Current Configuration</h3>
            <p style="word-break: break-all; overflow-wrap: anywhere;"><strong>ICS URL:</strong><br>{{ config.ics_url or 'Not configured' }}</p>
            <p style="margin-top: 10px; word-break: break-all; overflow-wrap: anywhere;"><strong>Calendar ID:</strong><br>{{ config.calendar_id or 'primary' }}</p>
            <p style="margin-top: 10px;"><strong>Sync Interval:</strong><br>{{ config.sync_interval or 900 }} seconds ({{ ((config.sync_interval or 900) / 60) | int }} minutes)</p>
            <p style="margin-top: 10px;"><strong>Full Sync Schedule:</strong><br>{{ '%02d'|format(config.full_sync_hour if config.full_sync_hour is defined else 0) }}:00 {{ config.full_sync_timezone or 'UTC' }}</p>
            {% if config.ics_timezone or config.gcal_timezone %}
            <p style="margin-top: 10px;"><strong>Detected Timezones:</strong><br>
                ICS: {{ config.ics_timezone or 'Unknown' }}{% if config.ics_offset %} ({{ config.ics_offset }}){% endif %}<br>
                Google Calendar: {{ config.gcal_timezone or 'Unknown' }}{% if config.gcal_offset %} ({{ config.gcal_offset }}){% endif %}
            </p>
            {% endif %}
            <p style="margin-top: 10px;"><strong>Next Quick Sync:</strong><br><span id="nextQuickSync">Calculating...</span></p>
            <p style="margin-top: 10px;"><strong>Next Full Sync:</strong><br><span id="nextFullSync">Calculating...</span></p>
        </div>
        
        <div>
            <h3 style="font-size: 16px; margin-bottom: 10px;">Actions</h3>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="triggerSync(false)" id="fullSyncBtn">Full Sync</button>
                <button class="btn" onclick="triggerSync(true)" id="quickSyncBtn">7-Day Sync</button>
            </div>
            <p class="help-text" style="margin-top: 10px;">Manually trigger a sync: Full syncs all events, 7-Day syncs only the next week.</p>
            
            <div id="syncResult" style="margin-top: 15px;"></div>
        </div>
    </div>
</div>

<div class="card">
    <h2>Recent Activity</h2>
    <div id="recentLogs">
        <p style="color: #666;">Loading recent logs...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let refreshInterval = 30000; // Default: 30 seconds
    let refreshTimer = null;
    
    function loadRecentLogs() {
        fetch('/api/logs?limit=10')
            .then(response => response.json())
            .then(logs => {
                const container = document.getElementById('recentLogs');
                if (logs.length === 0) {
                    container.innerHTML = '<p style="color: #666;">No logs yet.</p>';
                    return;
                }
                
                // Check if a sync is happening (recent INFO: Starting sync or ADD/UPDATE logs)
                const recentLogs = logs.slice(-5);
                const isSyncing = recentLogs.some(log => 
                    log.message.includes('Starting sync') || 
                    log.level === 'ADD' || 
                    log.level === 'UPDATE' ||
                    (log.timestamp && (Date.now() - new Date(log.timestamp).getTime() < 5000))
                );
                
                // Adjust refresh rate based on activity
                const newInterval = isSyncing ? 2000 : 30000; // 2s during sync, 30s idle
                if (newInterval !== refreshInterval) {
                    refreshInterval = newInterval;
                    clearInterval(refreshTimer);
                    refreshTimer = setInterval(loadRecentLogs, refreshInterval);
                    // Also refresh sync schedule when sync activity changes
                    loadSyncSchedule();
                }
                
                let html = '<div style="font-size: 13px;">';
                logs.reverse().forEach(log => {
                    const levelClass = log.level === 'ERROR' ? 'error' : 
                                     log.level === 'WARNING' ? 'warning' : 
                                     log.level === 'SUCCESS' ? 'success' : '';
                    const levelIcon = log.level === 'ERROR' ? '‚ùå' : 
                                    log.level === 'WARNING' ? '‚ö†Ô∏è' : 
                                    log.level === 'SUCCESS' ? '‚úì' : 
                                    log.level === 'ADD' ? '‚ûï' :
                                    log.level === 'UPDATE' ? 'üîÑ' : 
                                    log.level === 'DELETE' ? '‚ùé' :
                                    log.level === 'NO_CHANGE' ? '‚ûñ' : '‚ÑπÔ∏è';
                    
                    html += `<div style="padding: 8px; border-left: 3px solid ${
                        log.level === 'ERROR' ? '#dc3545' :
                        log.level === 'WARNING' ? '#ffc107' :
                        log.level === 'SUCCESS' ? '#28a745' :
                        log.level === 'ADD' ? '#17a2b8' :
                        log.level === 'UPDATE' ? '#007bff' :
                        log.level === 'DELETE' ? '#dc3545' :
                        log.level === 'NO_CHANGE' ? '#adb5bd' : '#6c757d'
                    }; margin-bottom: 5px; background: #f8f9fa;">
                        <span style="color: #666;">${new Date(log.timestamp).toLocaleString()}</span>
                        <strong style="margin-left: 10px;">${levelIcon} ${log.level}</strong>
                        <span style="margin-left: 10px;">${log.message}</span>
                    </div>`;
                });
                html += '</div>';
                html += '<p style="margin-top: 15px;"><a href="/logs">View all logs ‚Üí</a></p>';
                container.innerHTML = html;
            })
            .catch(err => {
                document.getElementById('recentLogs').innerHTML = 
                    '<p style="color: #dc3545;">Failed to load logs</p>';
            });
    }
    
    function triggerSync(quickSync) {
        const fullBtn = document.getElementById('fullSyncBtn');
        const quickBtn = document.getElementById('quickSyncBtn');
        const result = document.getElementById('syncResult');
        
        fullBtn.disabled = true;
        quickBtn.disabled = true;
        
        const syncType = quickSync ? '7-Day' : 'Full';
        result.innerHTML = `<p style="color: #666;">${syncType} sync in progress...</p>`;
        
        fetch(`/api/sync/trigger?quick_sync=${quickSync}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    result.innerHTML = `
                        <div class="status success">
                            ‚úì ${syncType} sync completed successfully!<br>
                            Added: ${data.result.added}, Updated: ${data.result.updated}, Deleted: ${data.result.deleted}, Errors: ${data.result.errors}
                        </div>
                    `;
                    loadRecentLogs();
                } else {
                    result.innerHTML = `
                        <div class="status error">
                            ‚ùå Sync failed: ${data.message}
                        </div>
                    `;
                }
            })
            .catch(err => {
                result.innerHTML = `
                    <div class="status error">
                        ‚ùå Error: ${err.message}
                    </div>
                `;
            })
            .finally(() => {
                fullBtn.disabled = false;
                quickBtn.disabled = false;
            });
    }
    
    // Countdown timers
    let nextQuickSyncTime = null;
    let nextFullSyncTime = null;
    
    function updateCountdowns() {
        const now = new Date();
        
        if (nextQuickSyncTime) {
            const diff = nextQuickSyncTime - now;
            if (diff > 0) {
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                document.getElementById('nextQuickSync').textContent = `${minutes}m ${seconds}s`;
            } else {
                document.getElementById('nextQuickSync').textContent = 'Running now...';
            }
        }
        
        if (nextFullSyncTime) {
            const diff = nextFullSyncTime - now;
            if (diff > 0) {
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                if (hours > 0) {
                    document.getElementById('nextFullSync').textContent = `${hours}h ${minutes}m`;
                } else {
                    document.getElementById('nextFullSync').textContent = `${minutes}m`;
                }
            } else {
                document.getElementById('nextFullSync').textContent = 'Running now...';
            }
        }
    }
    
    function loadSyncSchedule() {
        fetch('/api/sync/schedule')
            .then(response => response.json())
            .then(data => {
                nextQuickSyncTime = new Date(data.next_quick_sync);
                nextFullSyncTime = new Date(data.next_full_sync);
                updateCountdowns();
            })
            .catch(err => {
                console.error('Failed to load sync schedule:', err);
            });
    }
    
    // Load logs on page load
    loadRecentLogs();
    loadSyncSchedule();
    
    // Start refresh timer
    refreshTimer = setInterval(loadRecentLogs, refreshInterval);
    
    // Update countdowns every second
    setInterval(updateCountdowns, 1000);
    
    // Refresh schedule every 5 seconds
    setInterval(loadSyncSchedule, 5000);
    
    // Load and display version
    fetch('/api/version')
        .then(response => response.json())
        .then(data => {
            // Add version to page footer if not already there
            if (!document.getElementById('appVersion')) {
                const versionDiv = document.createElement('div');
                versionDiv.id = 'appVersion';
                versionDiv.style.cssText = 'position: fixed; bottom: 10px; right: 10px; font-size: 11px; color: #999; font-family: monospace;';
                versionDiv.textContent = `v${data.version}`;
                document.body.appendChild(versionDiv);
            }
        })
        .catch(err => console.error('Failed to load version:', err));
</script>
{% endblock %}
